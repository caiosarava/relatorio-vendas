<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <style>
        /* MESMO CSS DO ORIGINAL - MANTIDO PARA COMPATIBILIDADE VISUAL */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); min-height: 100vh; padding: 20px; }
        .container { background: white; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); width: 100%; max-width: 1600px; margin: 0 auto; overflow: hidden; }
        .auth-container { padding: 60px 40px; text-align: center; max-width: 500px; margin: 0 auto; }
        .auth-container h1 { color: #1e3c72; margin-bottom: 10px; font-size: 2.5em; }
        .form-group { margin-bottom: 20px; text-align: left; }
        .form-group label { display: block; margin-bottom: 8px; color: #333; font-weight: 500; }
        .form-group input { width: 100%; padding: 15px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 1em; }
        .btn { padding: 15px 40px; border: none; border-radius: 10px; font-size: 1.1em; font-weight: 600; cursor: pointer; transition: all 0.3s; width: 100%; }
        .btn-primary { background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); color: white; }
        .dashboard { display: none; }
        .header { background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); padding: 30px 40px; color: white; display: flex; justify-content: space-between; align-items: center; }
        .header-info { display: flex; align-items: center; gap: 20px; }
        .refresh-btn { background: rgba(255, 255, 255, 0.2); color: white; padding: 10px 20px; border: 1px solid rgba(255, 255, 255, 0.5); border-radius: 8px; cursor: pointer; }
        .logout-btn { background: #e74c3c; color: white; padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; }
        .content { padding: 40px; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 40px; }
        .stat-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 30px; border-radius: 15px; color: white; text-align: center; }
        .stat-card.revenue { background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%); }
        .stat-card.users { background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); }
        .stat-card.products { background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%); }
        .stat-value { font-size: 2.5em; font-weight: 700; }
        .charts-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 30px; margin-bottom: 40px; }
        .chart-box { background: white; padding: 25px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1); }
        .table-container { background: white; padding: 30px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1); overflow-x: auto; margin-bottom: 30px; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 15px; text-align: left; border-bottom: 1px solid #eee; }
        th { background-color: #f4f4f8; color: #1e3c72; }
        .filter-section { background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 30px; display: flex; gap: 15px; flex-wrap: wrap; align-items: end; }
        .filter-group { flex: 1; min-width: 200px; }
        .filter-group input, .filter-group select { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #ddd; }
        .filter-btn { padding: 10px 25px; background: #1e3c72; color: white; border: none; border-radius: 8px; cursor: pointer; }
        .error { background: #fee; color: #c33; padding: 15px; border-radius: 8px; margin-top: 10px; }
    </style>
</head>
<body>
    <div id="authScreen" class="container">
        <div class="auth-container">
            <h1>üîê Admin Dashboard</h1>
            <p>Acesso restrito (Dados Firebase)</p>
            <div class="form-group"><label>Usu√°rio</label><input type="text" id="adminUser" placeholder="admin"></div>
            <div class="form-group"><label>Senha</label><input type="password" id="adminPass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"></div>
            <button class="btn btn-primary" onclick="adminLogin()" id="btnLogin">Entrar</button>
            <div id="loginMessage"></div>
        </div>
    </div>

    <div id="dashboardScreen" class="container dashboard">
        <div class="header">
            <h1>üìä Dashboard Administrativo Global</h1>
            <div class="header-info">
                <button class="refresh-btn" onclick="loadDashboardData()">üîÑ Atualizar</button>
                <button class="logout-btn" onclick="adminLogout()">Sair</button>
            </div>
        </div>

        <div class="content">
            <div class="filter-section">
                <div class="filter-group"><label>In√≠cio</label><input type="date" id="filterStartDate"></div>
                <div class="filter-group"><label>Fim</label><input type="date" id="filterEndDate"></div>
                <div class="filter-group">
                    <label>Usu√°rio</label>
                    <select id="filterUser"><option value="">Todos</option></select>
                </div>
                <button class="filter-btn" onclick="applyFilters()">Aplicar</button>
            </div>

            <div class="stats-grid">
                <div class="stat-card revenue">
                    <div class="stat-label">Receita Total</div><div class="stat-value" id="totalRevenue">R$ 0,00</div>
                </div>
                <div class="stat-card users">
                    <div class="stat-label">Usu√°rios Ativos</div><div class="stat-value" id="totalUsers">0</div>
                </div>
                <div class="stat-card products">
                    <div class="stat-label">Total Vendas</div><div class="stat-value" id="totalSales">0</div>
                </div>
            </div>

            <div class="charts-grid">
                <div class="chart-box"><h2>Top Produtos</h2><canvas id="topProductsChart"></canvas></div>
                <div class="chart-box"><h2>Receita no Tempo</h2><canvas id="timelineChart"></canvas></div>
            </div>

            <div class="table-container">
                <h2>üìã Todas as Vendas</h2>
                <table id="allSalesTable">
                    <thead><tr><th>Data</th><th>Usu√°rio</th><th>Produto</th><th>Qtd</th><th>Total</th></tr></thead>
                    <tbody id="allSalesTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.1/firebase-app.js";
        import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.12.1/firebase-firestore.js";

        // --- MESMA CONFIG DO INDEX.HTML ---
        const firebaseConfig = {
            apiKey: "SUA_API_KEY",
            authDomain: "SEU_DOMINIO.firebaseapp.com",
            projectId: "SEU_PROJECT_ID",
            storageBucket: "SEU_BUCKET.appspot.com",
            messagingSenderId: "SEU_ID",
            appId: "SEU_APP_ID"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Login Simples
        const CREDENTIALS = { user: 'daes', pass: 'olimpicodaes1' };
        
        let allData = [];
        let charts = {};

        window.adminLogin = () => {
            const u = document.getElementById('adminUser').value;
            const p = document.getElementById('adminPass').value;
            if(u === CREDENTIALS.user && p === CREDENTIALS.pass) {
                document.getElementById('authScreen').style.display = 'none';
                document.getElementById('dashboardScreen').style.display = 'block';
                loadDashboardData();
            } else {
                document.getElementById('loginMessage').innerHTML = '<div class="error">Erro!</div>';
            }
        };

        window.adminLogout = () => window.location.reload();

        window.loadDashboardData = async () => {
            const btn = document.querySelector('.refresh-btn');
            btn.textContent = '‚è≥ ...';
            allData = [];
            
            try {
                const snapshot = await getDocs(collection(db, "sales"));
                snapshot.forEach(doc => allData.push(doc.data()));
                
                // Popula Filtro de Usu√°rios
                const users = [...new Set(allData.map(s => s.userEmail))];
                const select = document.getElementById('filterUser');
                select.innerHTML = '<option value="">Todos</option>' + 
                    users.map(u => `<option value="${u}">${u}</option>`).join('');
                
                applyFilters();
            } catch (e) {
                console.error(e);
                alert("Erro ao baixar dados do Firebase.");
            } finally {
                btn.textContent = 'üîÑ Atualizar';
            }
        };

        window.applyFilters = () => {
            const start = document.getElementById('filterStartDate').value;
            const end = document.getElementById('filterEndDate').value;
            const user = document.getElementById('filterUser').value;

            const filtered = allData.filter(s => {
                if (start && s.date < start) return false;
                if (end && s.date > end) return false;
                if (user && s.userEmail !== user) return false;
                return true;
            });

            renderDashboard(filtered);
        };

        function renderDashboard(data) {
            // Cards
            const totalRev = data.reduce((a, b) => a + parseFloat(b.total), 0);
            document.getElementById('totalRevenue').textContent = `R$ ${totalRev.toFixed(2)}`;
            document.getElementById('totalSales').textContent = data.length;
            document.getElementById('totalUsers').textContent = new Set(data.map(s=>s.userEmail)).size;

            // Tabela
            const tbody = document.getElementById('allSalesTableBody');
            tbody.innerHTML = data.sort((a,b) => b.date.localeCompare(a.date)).slice(0, 100).map(s => `
                <tr>
                    <td>${s.date}</td>
                    <td>${s.userName || s.userEmail}</td>
                    <td>${s.product}</td>
                    <td>${s.quantity}</td>
                    <td>R$ ${parseFloat(s.total).toFixed(2)}</td>
                </tr>
            `).join('');

            // Gr√°ficos
            if(charts.top) charts.top.destroy();
            if(charts.time) charts.time.destroy();

           // Top Produtos (Corrigido para somar Quantidade)
const prodData = data.reduce((acc, s) => { 
    // Garante que √© n√∫mero para somar corretamente
    const qtd = parseFloat(s.quantity) || 0; 
    acc[s.product] = (acc[s.product] || 0) + qtd; 
    return acc; 
}, {});

// Ordena do maior para o menor e pega os Top 10
const sortedProducts = Object.entries(prodData)
    .sort((a, b) => b[1] - a[1]) // Ordena decrescente
    .slice(0, 10); // Pega apenas os 10 primeiros

charts.top = new Chart(document.getElementById('topProductsChart'), {
    type: 'bar',
    data: {
        labels: sortedProducts.map(item => item[0]), // Nome do produto
        datasets: [{ 
            label: 'Quantidade Vendida', 
            data: sortedProducts.map(item => item[1]), // Total somado
            backgroundColor: '#3498db' 
        }]
    }
});

            // Timeline
            const timeData = data.reduce((acc, s) => { 
                const k = s.date.substring(0, 7); 
                acc[k] = (acc[k]||0) + parseFloat(s.total); 
                return acc; 
            }, {});
            const sortedKeys = Object.keys(timeData).sort();
            
            charts.time = new Chart(document.getElementById('timelineChart'), {
                type: 'line',
                data: {
                    labels: sortedKeys,
                    datasets: [{ label: 'Receita', data: sortedKeys.map(k=>timeData[k]), borderColor: '#27ae60', tension: 0.4 }]
                }
            });
        }
    </script>
</body>
</html>