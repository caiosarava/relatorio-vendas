<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciar Estoque</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; display: flex; justify-content: center; align-items: center; padding: 20px; }
        .container { background: white; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); width: 100%; max-width: 1200px; overflow: hidden; }
        .auth-screen { padding: 60px 40px; text-align: center; }
        .auth-screen h1 { color: #667eea; margin-bottom: 10px; font-size: 2.5em; }
        .auth-screen p { color: #666; margin-bottom: 40px; }
        .form-group { margin-bottom: 20px; text-align: left; }
        .form-group label { display: block; margin-bottom: 8px; color: #333; font-weight: 500; font-size: 1.1em; }
        .form-group input, .form-group select { width: 100%; padding: 15px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 1em; transition: border-color 0.3s; }
        .form-group input:focus, .form-group select:focus { outline: none; border-color: #667eea; }
        .btn { padding: 15px 40px; border: none; border-radius: 10px; font-size: 1.1em; font-weight: 600; cursor: pointer; transition: all 0.3s; }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }
        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; width: 100%; margin-top: 10px; }
        .btn-primary:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4); }
        .btn-secondary-light { background: rgba(255, 255, 255, 0.2); color: white; padding: 10px 20px; border: 1px solid rgba(255, 255, 255, 0.5); border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s; }
        .btn-secondary-light:hover { background: white; color: #667eea; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px 40px; display: flex; justify-content: space-between; align-items: center; color: white; }
        .header h1 { font-size: 1.8em; }
        .user-info { display: flex; align-items: center; gap: 15px; }
        .avatar { width: 50px; height: 50px; border-radius: 50%; background: white; color: #667eea; display: flex; align-items: center; justify-content: center; font-size: 1.5em; font-weight: bold; }
        .main-screen { display: flex; flex-direction: column; }
        .content { padding: 40px; }
        .inventory-form { background: #f8f9fa; padding: 30px; border-radius: 15px; margin-bottom: 30px; }
        .inventory-form h2 { color: #333; margin-bottom: 25px; font-size: 1.5em; }
        .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .inventory-list h2 { color: #333; margin-bottom: 20px; font-size: 1.5em; }
        .btn-small { padding: 8px 15px; border: none; border-radius: 6px; cursor: pointer; font-size: 0.9em; font-weight: 600; transition: all 0.3s; margin-left: 5px; }
        .btn-edit { background: #3498db; color: white; }
        .btn-edit:hover { background: #2980b9; }
        .btn-delete { background: #e74c3c; color: white; }
        .btn-delete:hover { background: #c0392b; }
        .table-container { background: white; padding: 25px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1); overflow-x: auto; }
        #inventoryTable { width: 100%; border-collapse: collapse; }
        #inventoryTable th, #inventoryTable td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #eee; }
        #inventoryTable th { background-color: #f4f4f8; color: #667eea; font-weight: 600; text-transform: uppercase; font-size: 0.9em; }
        #inventoryTable tr:hover { background-color: #f8f9fa; }
        .empty-state { text-align: center; padding: 60px 20px; color: #999; }
        .error { background: #fee; color: #c33; padding: 15px; border-radius: 8px; margin-top: 15px; border: 1px solid #fcc; display: none; }
        .success { background: #efe; color: #3c3; padding: 15px; border-radius: 8px; margin-top: 15px; border: 1px solid #cfc; display: none; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.4); }
        .modal-content { background-color: white; margin: 10% auto; padding: 30px; border-radius: 15px; width: 90%; max-width: 500px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        .modal-header { font-size: 1.5em; color: #333; margin-bottom: 20px; font-weight: 600; }
        .modal-buttons { display: flex; gap: 10px; margin-top: 20px; }
        .modal-buttons button { flex: 1; padding: 12px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s; }
        .btn-confirm { background: #27ae60; color: white; }
        .btn-confirm:hover { background: #229954; }
        .btn-cancel { background: #e0e0e0; color: #333; }
        .btn-cancel:hover { background: #d0d0d0; }
        .hidden { display: none !important; }
        @media (max-width: 768px) { .header { flex-direction: row; gap: 10px; } .header h1 { font-size: 1.3em; } .content { padding: 20px; } .form-row { grid-template-columns: 1fr; } .btn-small { margin-top: 5px; } }
    </style>
</head>
<body>
    <div id="mainScreen" class="container main-screen">
        <div class="header">
            <h1>üì¶ Meu Estoque</h1>
            <div class="user-info">
                <span id="userAvatar" class="avatar">U</span>
                <a href="index.html" class="btn-secondary-light" style="text-decoration: none;">‚Üê Voltar para Vendas</a>
                <button class="btn-secondary-light" onclick="logout()">Sair</button>
            </div>
        </div>

        <div class="content">
            <div class="inventory-form">
                <h2>‚ûï Adicionar Produto/Servi√ßo</h2>
                <div class="form-row">
                    <div class="form-group">
                        <label>Nome do Produto/Servi√ßo</label>
                        <input type="text" id="productName" placeholder="Ex: Consultoria Premium" maxlength="100">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Valor Unit√°rio (R$)</label>
                        <input type="number" id="unitPrice" min="0" step="0.01" placeholder="0.00">
                    </div>
                    <div class="form-group">
                        <label>Quantidade</label>
                        <input type="number" id="quantity" min="0" placeholder="0">
                    </div>
                </div>
                <button class="btn btn-primary" onclick="addItem()">‚ûï Adicionar</button>
                <div id="successMessage" class="success"></div>
                <div id="errorMessage" class="error"></div>
            </div>

            <div class="inventory-list">
                <h2>üìã Produtos/Servi√ßos em Estoque</h2>
                <div class="table-container">
                    <table id="inventoryTable">
                        <thead>
                            <tr>
                                <th>Nome do Produto/Servi√ßo</th>
                                <th>Valor Unit√°rio (R$)</th>
                                <th>Quantidade</th>
                                <th>Valor Total (R$)</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="inventoryTableBody">
                            <tr><td colspan="5" style="text-align: center; padding: 40px;">Carregando...</td></tr>
                        </tbody>
                    </table>
                </div>
                <div id="emptyState" class="empty-state hidden">
                    Nenhum produto adicionado ainda. Comece a adicionar itens!
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Edi√ß√£o -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">Editar Produto/Servi√ßo</div>
            <div class="form-group">
                <label>Nome do Produto/Servi√ßo</label>
                <input type="text" id="editProductName" placeholder="Ex: Consultoria Premium" maxlength="100">
            </div>
            <div class="form-group">
                <label>Valor Unit√°rio (R$)</label>
                <input type="number" id="editUnitPrice" min="0" step="0.01" placeholder="0.00">
            </div>
            <div class="form-group">
                <label>Quantidade</label>
                <input type="number" id="editQuantity" min="0" placeholder="0">
            </div>
            <div class="modal-buttons">
                <button class="btn-confirm" onclick="saveEdit()">Salvar</button>
                <button class="btn-cancel" onclick="closeEditModal()">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Modal de Confirma√ß√£o de Exclus√£o -->
    <div id="deleteModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">Confirmar Exclus√£o</div>
            <p>Tem certeza que deseja excluir <strong id="deleteProductName"></strong>?</p>
            <p style="color: #999; font-size: 0.9em; margin-top: 10px;">Esta a√ß√£o n√£o pode ser desfeita.</p>
            <div class="modal-buttons">
                <button class="btn-confirm" onclick="confirmDelete()">Excluir</button>
                <button class="btn-cancel" onclick="closeDeleteModal()">Cancelar</button>
            </div>
        </div>
    </div>

    <script type="module">
        // CONFIGURA√á√ÉO SUPABASE
        const SUPABASE_URL = "https://excdrnjzwldleyzpdriv.supabase.co";
        const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV4Y2Rybmp6d2xkbGV5enBkcml2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQwNTU4MTksImV4cCI6MjA3OTYzMTgxOX0.IC4aKCNFrGwv9XyR9c2k5YppqLDgM7Bnq_oiuJdapKA";

        const { createClient } = supabase;
        const db = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let currentUser = null;
        let editingItemId = null;
        let deletingItemId = null;

        // VERIFICAR SESS√ÉO - Redirecionar se n√£o autenticado
        window.addEventListener('load', async () => {
            try {
                const { data: { session }, error } = await db.auth.getSession();
                
                if (error || !session) {
                    window.location.href = 'index.html';
                    return;
                }
                
                // Obter dados do usu√°rio do Supabase Auth
                const { data: { user }, error: userError } = await db.auth.getUser();
                if (userError || !user) {
                    window.location.href = 'index.html';
                    return;
                }
                
                currentUser = user;
                document.getElementById('userAvatar').textContent = currentUser.email.charAt(0).toUpperCase();
                await loadInventory();
            } catch (error) {
                console.error('Erro ao verificar sess√£o:', error);
                window.location.href = 'index.html';
            }
        });

        // LOGOUT
        window.logout = async () => {
            try {
                await db.auth.signOut();
                window.location.href = 'index.html';
            } catch (error) {
                console.error('Erro ao fazer logout:', error);
                window.location.href = 'index.html';
            }
        };

        // CARREGAR ESTOQUE
        window.loadInventory = async () => {
            const tbody = document.getElementById('inventoryTableBody');
            const emptyState = document.getElementById('emptyState');
            
            try {
                const { data, error } = await db
                    .from('inventory')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .order('created_at', { ascending: false });

                if (error) throw error;

                if (data.length === 0) {
                    tbody.innerHTML = '';
                    emptyState.classList.remove('hidden');
                } else {
                    emptyState.classList.add('hidden');
                    tbody.innerHTML = data.map(item => `
                        <tr>
                            <td>${escapeHtml(item.product_name)}</td>
                            <td>R$ ${parseFloat(item.unit_price).toFixed(2)}</td>
                            <td>${item.quantity}</td>
                            <td>R$ ${(parseFloat(item.unit_price) * item.quantity).toFixed(2)}</td>
                            <td>
                                <button class="btn-small btn-edit" onclick="openEditModal(${item.id}, '${escapeAttr(item.product_name)}', ${item.unit_price}, ${item.quantity})">‚úèÔ∏è Editar</button>
                                <button class="btn-small btn-delete" onclick="openDeleteModal(${item.id}, '${escapeAttr(item.product_name)}')">üóëÔ∏è Excluir</button>
                            </td>
                        </tr>
                    `).join('');
                }
            } catch (error) {
                document.getElementById('errorMessage').innerHTML = `Erro ao carregar estoque: ${error.message}`;
                document.getElementById('errorMessage').style.display = 'block';
            }
        };

        // ADICIONAR ITEM
        window.addItem = async () => {
            const productName = document.getElementById('productName').value.trim();
            const unitPrice = parseFloat(document.getElementById('unitPrice').value);
            const quantity = parseInt(document.getElementById('quantity').value);
            const successDiv = document.getElementById('successMessage');
            const errorDiv = document.getElementById('errorMessage');

            successDiv.style.display = 'none';
            errorDiv.style.display = 'none';

            if (!productName || isNaN(unitPrice) || isNaN(quantity) || unitPrice < 0 || quantity < 0) {
                errorDiv.innerHTML = 'Preencha todos os campos corretamente';
                errorDiv.style.display = 'block';
                return;
            }

            try {
                const { error } = await db.from('inventory').insert([{
                    user_id: currentUser.id,
                    product_name: productName,
                    unit_price: unitPrice,
                    quantity: quantity
                }]);

                if (error) throw error;

                successDiv.innerHTML = 'Produto adicionado com sucesso!';
                successDiv.style.display = 'block';
                
                document.getElementById('productName').value = '';
                document.getElementById('unitPrice').value = '';
                document.getElementById('quantity').value = '';

                setTimeout(() => {
                    successDiv.style.display = 'none';
                }, 3000);

                await loadInventory();
            } catch (error) {
                errorDiv.innerHTML = `Erro: ${error.message}`;
                errorDiv.style.display = 'block';
            }
        };

        // ABRIR MODAL DE EDI√á√ÉO
        window.openEditModal = (id, productName, unitPrice, quantity) => {
            editingItemId = id;
            document.getElementById('editProductName').value = productName;
            document.getElementById('editUnitPrice').value = unitPrice;
            document.getElementById('editQuantity').value = quantity;
            document.getElementById('editModal').style.display = 'block';
        };

        // FECHAR MODAL DE EDI√á√ÉO
        window.closeEditModal = () => {
            document.getElementById('editModal').style.display = 'none';
            editingItemId = null;
        };

        // SALVAR EDI√á√ÉO
        window.saveEdit = async () => {
            const productName = document.getElementById('editProductName').value.trim();
            const unitPrice = parseFloat(document.getElementById('editUnitPrice').value);
            const quantity = parseInt(document.getElementById('editQuantity').value);

            if (!productName || isNaN(unitPrice) || isNaN(quantity) || unitPrice < 0 || quantity < 0) {
                alert('Preencha todos os campos corretamente');
                return;
            }

            try {
                const { error } = await db
                    .from('inventory')
                    .update({
                        product_name: productName,
                        unit_price: unitPrice,
                        quantity: quantity
                    })
                    .eq('id', editingItemId)
                    .eq('user_id', currentUser.id);

                if (error) throw error;

                closeEditModal();
                await loadInventory();
            } catch (error) {
                alert(`Erro ao atualizar: ${error.message}`);
            }
        };

        // ABRIR MODAL DE EXCLUS√ÉO
        window.openDeleteModal = (id, productName) => {
            deletingItemId = id;
            document.getElementById('deleteProductName').textContent = productName;
            document.getElementById('deleteModal').style.display = 'block';
        };

        // FECHAR MODAL DE EXCLUS√ÉO
        window.closeDeleteModal = () => {
            document.getElementById('deleteModal').style.display = 'none';
            deletingItemId = null;
        };

        // CONFIRMAR EXCLUS√ÉO
        window.confirmDelete = async () => {
            try {
                const { error } = await db
                    .from('inventory')
                    .delete()
                    .eq('id', deletingItemId)
                    .eq('user_id', currentUser.id);

                if (error) throw error;

                closeDeleteModal();
                await loadInventory();
            } catch (error) {
                alert(`Erro ao excluir: ${error.message}`);
            }
        };

        // FECHAR MODAL CLICANDO FORA
        window.onclick = (event) => {
            const editModal = document.getElementById('editModal');
            const deleteModal = document.getElementById('deleteModal');
            if (event.target === editModal) editModal.style.display = 'none';
            if (event.target === deleteModal) deleteModal.style.display = 'none';
        };

        // FUN√á√ïES AUXILIARES
        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, m => map[m]);
        }

        function escapeAttr(text) {
            return text.replace(/'/g, "\\'");
        }
    </script>
</body>
</html>
